//
// Created by Riven on 06.07.2021.
//

#include "net.h"
#include "ca_certificate.h"

typedef void (*Method) (char *, char *,
                        char *, char *);

typedef struct requestContext {
    char* 		res_addr;
    char*       current_work_dir;
    char*       current_cert;
    char*		request;
    char*		response;

    Method     method;

} reqeustCtx;


void init_ssl() {
    SSL_load_error_strings();
    SSL_library_init();
}

void print_context(const char* message, int fd) {
    /* if error acquires */
    if (fd == 2) {
        printf("Erorr: %s\n", message);
        exit(-1);
    }
}

void cert_free(X509_STORE *cert_store,
               SSL_CTX *ssl_ctx,
               BIO *ca_cert_bio) {
    X509_STORE_free(cert_store);
    SSL_CTX_free(ssl_ctx);
    BIO_free_all(ca_cert_bio);
    print_context("All cert and ssl context variables memory is free!\n", 1);
}

void custom_free(char *res_addr, char *request,
                 char *current_work_dir,  char *current_cert) {
    free(res_addr);
    free(request);

    free(current_work_dir);
    free(current_cert);

    print_context("All custom variables memory is free!\n", 1);
}

char* make_secure_connection(const char* hostname, const char* port,
                            const char* bot_token, const char* bot_method,
                            const char* body) {
    long res;

    SSL*		ssl;
    SSL_CTX* 	ssl_ctx;

    X509_STORE*	cert_store;
    X509*		ca_cert;

    BIO*		bio;
    BIO*		ca_cert_bio;

    const SSL_METHOD* method;

    struct requestContext reqeustCtx;


    reqeustCtx.method = &custom_free;
    reqeustCtx.res_addr = (char *)malloc(sizeof(char) * (strlen(hostname) + strlen(port) + 2));
    strcat(strcat(strcat(reqeustCtx.res_addr, hostname), ":"), port);

    reqeustCtx.request = (char *)malloc(sizeof(char) * (BUFFSIZE + 1));
    reqeustCtx.response = (char *)malloc(sizeof(char) * (BUFFSIZE + 1));

    reqeustCtx.current_work_dir = (char *) malloc(sizeof(char) * (PATHMAX + 1));
    /* 1 for null byte, 1 for slash, 7 for cert name */
    /* don't want to reallocate memory in future  */
    reqeustCtx.current_cert = (char *) malloc(sizeof(char) * (PATHMAX + 9));
    if (!(getcwd(reqeustCtx.current_work_dir, sizeof(char) * (PATHMAX + 1))))
        print_context("Could not get current dir information", 2);
    else {
        strcpy(reqeustCtx.current_cert, reqeustCtx.current_work_dir);
        strcat(reqeustCtx.current_cert, "/ca.cert");
    }

    if (!(method = TLS_client_method()))
        print_context("Could not use <TLS_client_method()>", 2);

    if (!(ssl_ctx = SSL_CTX_new(method)))
        print_context("Could not use <SSL_CTX_new(method)>", 2);

    /* linking BIO, SSL session and server endpoint 	*/
    /* BIO - basic input/output, SSL session is session */

    ssl = (void*)0;
    print_context("Trying to link...", 1);

    /* configure session */
    SSL_CTX_set_verify(ssl_ctx, SSL_VERIFY_PEER, NULL);
    SSL_CTX_set_verify_depth(ssl_ctx, 2);

    /* creating new x509 key store */
    if (!(cert_store = X509_STORE_new()))
    {
        print_context("Could not use <X509_STORE_new()>", 2);
        SSL_CTX_free(ssl_ctx);
    }

    /* load certificate to bio mem buffer */
    ca_cert_bio = BIO_new_mem_buf(__ca_cert, ca_cert_len);
    if (!(ca_cert = PEM_read_bio_X509(ca_cert_bio, NULL, 0, NULL))) {
        cert_free(cert_store, ssl_ctx, ca_cert_bio);
        reqeustCtx.method(reqeustCtx.res_addr, reqeustCtx.request,
                          reqeustCtx.current_work_dir, reqeustCtx.current_cert);
        print_context("Could not use <PEM_read_bio_X509(ca_cert_bio, NULL, 0, NULL)>", 2);
    }

    /* adding cert to x509 store */
    res = X509_STORE_add_cert(cert_store, ca_cert);
    if (res != 1) {
        cert_free(cert_store, ssl_ctx, ca_cert_bio);
        reqeustCtx.method(reqeustCtx.res_addr, reqeustCtx.request,
                          reqeustCtx.current_work_dir, reqeustCtx.current_cert);
        print_context("Could not use <X509_STORE_add_cert(cert_store, ca_cert)>" ,2);
    }

    /* adding cert_store to ssl_ctx */
    SSL_CTX_set_cert_store(ssl_ctx, cert_store);
    if (!(bio = BIO_new_ssl_connect(ssl_ctx))) {
        cert_free(cert_store, ssl_ctx, ca_cert_bio);
        reqeustCtx.method(reqeustCtx.res_addr, reqeustCtx.request,
                          reqeustCtx.current_work_dir, reqeustCtx.current_cert);
        print_context("Could not use <BIO_new_ssl_connect(ssl_ctx)>", 2);
    }

    /* prepare to connect */
    /* setting address to bio struct */
    res = BIO_set_conn_hostname(bio, reqeustCtx.res_addr);
    if (res != 1) {
        cert_free(cert_store, ssl_ctx, ca_cert_bio);
        reqeustCtx.method(reqeustCtx.res_addr, reqeustCtx.request,
                          reqeustCtx.current_work_dir, reqeustCtx.current_cert);
        print_context("Could not use <BIO_set_conn_hostname(bio, res_addr)>", 2);
    }

    /* getting ssl pointer  for further manipulations*/
    BIO_get_ssl(bio, &ssl);
    if (ssl == (void *)0){
        cert_free(cert_store, ssl_ctx, ca_cert_bio);
        reqeustCtx.method(reqeustCtx.res_addr, reqeustCtx.request,
                          reqeustCtx.current_work_dir, reqeustCtx.current_cert);
        print_context("Could not use <BIO_get_ssl(bio, &ssl)>", 2);
    }

    /* trying to connect to current basic input/output stream */
    res = BIO_do_connect(bio);
    if (res != 1){
        cert_free(cert_store, ssl_ctx, ca_cert_bio);
        reqeustCtx.method(reqeustCtx.res_addr, reqeustCtx.request,
                          reqeustCtx.current_work_dir, reqeustCtx.current_cert);
        print_context("Could not use <BIO_do_connect(bio)>", 2);
    }

    res = SSL_get_verify_result(ssl);
    if (res != X509_V_OK)
        print_context("#### Cert validation error, trying to continue ####", 1);

    sprintf(reqeustCtx.request,
            "POST /bot%s/%s HTTP/1.1\r\n"
			"Host: %s\r\n"
			"Connection: close\r\n"
			"Content-Type: application/json\r\n"
   			"Content-Length: %d\r\n"
   			"\r\n"
   			"%s\r\n", bot_token, bot_method,
			reqeustCtx.res_addr, strlen(body), body);
    BIO_puts(bio, reqeustCtx.request);
	BIO_flush(bio);

    int read_bytes = 0;
    memset(reqeustCtx.response, '\0', BUFFSIZE);
	read_bytes = BIO_read(bio, reqeustCtx.response, BUFFSIZE);
	if (read_bytes <= 0) {
		printf("No response");
		exit(-1);
	}

    cert_free(cert_store, ssl_ctx, ca_cert_bio);
	// free memory //
    reqeustCtx.method(reqeustCtx.res_addr, reqeustCtx.request,
                      reqeustCtx.current_work_dir, reqeustCtx.current_cert);

    /* json response, need to parse */
    return reqeustCtx.response;
}
