//
// Created by Riven on 7/13/21.
//

#include "malware_logic.h"

#define RES_SIZE 24

char* get_sysinfo(void) {
	SYSTEM_INFO				sysInfo;
	MEMORYSTATUSEX 			memory_status;

	TCHAR					buffer[256];
	DWORD 					countof;

	PSYSTEM_LOGICAL_PROCESSOR_INFORMATION proc_info[256];

	char** 					res_text;
	char*					text;

	if (!(res_text = (char**)calloc(RES_SIZE, sizeof(char*)))){
		printf(TEXT("Can't allocate memory for result pointer on pointer array"));
		exit(-1);
	} else
	{
		*(res_text + RES_SIZE) = (void*)0;
		for (int i = 0; i < RES_SIZE - 1; i++) {
			*(res_text + i) = (char*)calloc(128, sizeof(char));
			*(*(res_text + i)) = '\0';
		}
	}

	if (!(text = (char*)calloc(1024, sizeof(char)))) {
		printf(TEXT("Can't allocate memory for pointer to result text"));
		exit(-1);
	}

	// don't want to create 2 dem array for desc and func //
	GetSystemInfo(&sysInfo);
	sprintf(*(res_text + 0), "Hardware information:\n");
	sprintf(*(res_text + 1), "  OEM ID: %lu\n", sysInfo.dwOemId);
	sprintf(*(res_text + 2), "  Number of processors: %lu\n",
		   sysInfo.dwNumberOfProcessors);
	sprintf(*(res_text + 3), "  Processor mask: %lu\n",
		   sysInfo.dwActiveProcessorMask);
	sprintf(*(res_text + 4), "  Processor type: %lu\n", sysInfo.dwProcessorType);
	sprintf(*(res_text + 5), "  Page size: %lu\n", sysInfo.dwPageSize);
	sprintf(*(res_text + 6), "  Minimum application address: %lx\n",
		   sysInfo.lpMinimumApplicationAddress);
	sprintf(*(res_text + 7), "  Maximum application address: %lx\n",
		   sysInfo.lpMaximumApplicationAddress);
	sprintf(*(res_text + 8), "  Active processor mask: %u\n",
		   sysInfo.dwActiveProcessorMask);

	sprintf(*(res_text + 9), "--------------------------------\n");
	sprintf(*(res_text + 10), "Memory information:\n");

	GlobalMemoryStatusEx(&memory_status);
	sprintf(*(res_text + 11), "  MemLoad: %ul\n", memory_status.dwMemoryLoad);
	sprintf(*(res_text + 12), "  dWord length: %ul\n", memory_status.dwLength);
	sprintf(*(res_text + 13), "  Virtual Memory: %ul\n", memory_status.ullAvailVirtual);
	sprintf(*(res_text + 14), "  Total page file: %ul\n", memory_status.ullTotalPageFile);
	sprintf(*(res_text + 15), "  Available phys memory: %ul\n", memory_status.ullAvailPhys);
	sprintf(*(res_text + 16), "  Available virtual memory: %ul\n", memory_status.ullAvailVirtual);

	sprintf(*(res_text + 17), "--------------------------------\n");
	sprintf(*(res_text + 18), "PC information: \n");
	countof = _countof(buffer);

	GetComputerName(buffer, &countof);
	sprintf(*(res_text + 19), "  PC name: %s\n", buffer);
	ZeroMemory(buffer, countof);

	GetUserName(buffer, &countof);
	sprintf(*(res_text + 20), "  Username: %s\n", buffer);
	ZeroMemory(buffer, countof);

	unsigned int count = _countof(buffer);
	GetWindowsDirectory(buffer, count);
	sprintf(*(res_text + 21), "  Windows directory: %s\n", buffer);
	ZeroMemory(buffer, countof);

	for (int i = 0; i < RES_SIZE - 1; i++) {
		strcat(text, *(res_text + i));
		free(*(res_text + i));
	}
	free(res_text);

	return text;
}