//
// Created by Riven on 7/13/21.
//
#include "jsonParser.h"

bool        validate_json(char* json) {
    int             counter;
    unsigned long   len;

    if (!(len=strlen(json)))
        return false;
    counter = 0;
    for (int i = 0; i < len; i++) {
        if (counter < 0)
            return false;
        // if "{" or "}" inside of string //
        // just pass string, that's all   //
        if (json[i] == skip_char) {
            i++;
            while (json[i] != skip_char && i < len)
                i++;
        }
        if (json[i] == start_char)
            counter += 1;
        else if (json[i] == end_char)
            counter -= 1;
    }
    return counter == 0 ? true : false;
}

char**      memory_allocation(char* json, unsigned long json_len) {
    int         res;
    char**      json_array;

    res = 0;
    for (int i = 0; i < json_len; i++) {
		if (json[i] == skip_char) {
			i++;
			while (json[i] != skip_char && i < json_len) {
				i++;
			}
		}
        if (json[i] == start_char)
            res += 1;
    }
    if (!(json_array=(char**) malloc(sizeof (char*) * (res + 1)))) {
        printf("Can't allocate memory to parse json.");
        exit(-1);
    }

    json_array[res] = (void*)0;

    return json_array;
}

char *strremove(char *str, const char *sub) {
    char *p, *q, *r;
    if ((q = r = strstr(str, sub)) != NULL) {
        size_t len = strlen(sub);
        while ((r = strstr(p = r + len, sub)) != NULL) {
            while (p < r)
                *q++ = *p++;
        }
        while ((*q++ = *p++) != '\0')
            continue;
    }
    return str;
}

char**      json_split(char* valid_json) {
    unsigned long   valid_json_len;
    unsigned int    json_starts;
    unsigned int    json_ends;

    unsigned int    flag;
    unsigned int    iter;

    char**          json_array;

    flag = 0;
    iter = 0;
    json_starts = 0;
    json_ends   = 0;
    valid_json_len = strlen(valid_json);
    json_array = memory_allocation(valid_json, valid_json_len);

    while (iter != valid_json_len ) {

        // if "{" or "}" inside of string //
        // just pass string, that's all   //
        if (valid_json[iter] == skip_char) {
            iter++;
            while (valid_json[iter] != skip_char && iter < valid_json_len) {
                iter++;
            }
        }
        if (valid_json[iter] == start_char) {
            json_starts = iter;
            iter++;
            continue;
        }
        if (valid_json[iter] == end_char) {
            printf("%d\n", json_starts);
            json_ends = iter;
            json_array[flag] = (char*) malloc(sizeof(char) * (json_ends - json_starts + 3));
            strncpy(json_array[flag], valid_json + json_starts, json_ends - json_starts + 1);
            json_array[flag][json_ends - json_starts + 1] = '\0';
            valid_json = strremove(valid_json, json_array[flag]);
            printf("%s\n", json_array[flag]);
            if (!strlen(valid_json) || strlen(valid_json) <= 3)
                break;
            iter = 0;
            flag +=1;
            continue;
        }
        iter += 1;
    }
    return json_array;
}


char** json_main(char* json ) {
	if (!validate_json(json)) {
		printf("Json is not valid. Terminating the process.");
		return ;
	}
	return json_split(json);
}
